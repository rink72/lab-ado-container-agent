trigger:
  - main

pool:
  vmImage: ubuntu-18.04

variables:
  trivyVersion: 0.23.0
  tag: $(Build.BuildNumber)
  imageName: "rink72/lab-ado-container-agent"
  registryServiceConnection: dockerhub-rink72

steps:
  - script: |
      sudo apt-get install rpm
      wget https://github.com/aquasecurity/trivy/releases/download/v$(trivyVersion)/trivy_$(trivyVersion)_Linux-64bit.deb
      sudo dpkg -i trivy_$(trivyVersion)_Linux-64bit.deb
      trivy -v
    displayName: Download and install trivy

  - task: CmdLine@2
    displayName: Run trivy configuration scan
    inputs:
      script: |
        trivy conf --exit-code 1 $(Build.SourcesDirectory)/src/

  - task: Docker@2
    displayName: Build image
    inputs:
      repository: $(imageName)
      command: build
      Dockerfile: "**/Dockerfile"
      buildContext: $(Build.SourcesDirectory)/src/
      tags: $(tag)

  - task: CmdLine@2
    displayName: Run trivy image scan
    inputs:
      script: |
        trivy image --ignorefile $(Build.SourcesDirectory)/config/.trivyignore --exit-code 0 --severity LOW,MEDIUM $(imageName):$(tag)
        trivy image --ignorefile $(Build.SourcesDirectory)/config/.trivyignore --exit-code 1 --severity HIGH,CRITICAL $(imageName):$(tag)

  #- ${{ eq(variables['Build.SourceBranch'], 'refs/heads/main') }}:

  - task: Docker@2
    displayName: Push image
    inputs:
      containerRegistry: $(registryServiceConnection)
      repository: $(imageName)
      command: push
      tags: $(tag), latest
